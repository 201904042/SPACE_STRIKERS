using Firebase.Auth;
using System;
using System.Collections;
using System.Collections.Generic;
using Unity.Properties;
using UnityEngine;
using UnityEngine.UI;

public class StoreUI : MainUIs
{
    public Transform PageBtns;

    public Transform Stores;
    public GameObject gotchaPage;
    public GameObject dailyPage;
    public GameObject itemPage;
    public GameObject moneyPage;

    public Transform Btn;
    public Button webStoreBtn;
    public Button backBtn;

    public GameObject[] StorePanels; 
    public Button[] StoreBtns;

    protected override void Awake()
    {
        base.Awake();
    }

    public override void SetComponent()
    {
        base.SetComponent();
        PageBtns = transform.GetChild(0).GetChild(0);
        Stores = transform.GetChild(0).GetChild(1);
        StorePanels = new GameObject[4];
        StoreBtns = new Button[4];
        Btn = transform.GetChild(1);
        webStoreBtn = Btn.GetChild(0).GetComponent<Button>();
        backBtn = Btn.GetChild(1).GetComponent<Button>();

        for (int i = 0; i < PageBtns.childCount; i++)
        {
            StoreBtns[i] = PageBtns.GetChild(i).GetComponent<Button>();
        }

        for (int i = 0; i < Stores.childCount; i++)
        {
            StorePanels[i] = Stores.GetChild(i).gameObject;
        }
    }

    protected override void OnEnable()
    {
        base.OnEnable();
        SetStoreBtns();
        SetUIBtn();
    }

    //StoreUI에서 인터페이스를 띄우는 객체는 ItmeBtnUI로 해당 버튼을 클릭할시 Interface GetValue를 받음

    private void SetUIBtn()
    {
        webStoreBtn.onClick.RemoveAllListeners();
        webStoreBtn.onClick.AddListener(GotoWebStore);

        backBtn.onClick.RemoveAllListeners();
        backBtn.onClick.AddListener(GotoMain);
    }

    private void SetStoreBtns()
    {
        //상점 버튼별로 나타낼 패널 코드 등록
        for (int i = 0; i < StoreBtns.Length; i++)
        {
            int code = i; //이거 없으면 다 똑같은 인덱스로 등록됨...
            StoreBtns[i].onClick.RemoveAllListeners();
            StoreBtns[i].onClick.AddListener(() => ActivatePanel(code));
        }

        ActivatePanel(0); //첫 화면은 가챠 페이지
    }
    

    /// <summary>
    /// 해당 번호의 스토어 패널 활성화
    /// </summary>
    /// <param name="index"></param>
    private void ActivatePanel(int index)
    {
        DeactivateAllPanels(); // 모든 패널 비활성화

        if (index >= 0 && index < StorePanels.Length)
        {
            StorePanels[index].SetActive(true); // 선택한 패널만 활성화
        }
    }

    /// <summary>
    /// 모든 스토어 패널을 비활성화하는 메소드
    /// </summary>
    private void DeactivateAllPanels()
    {
        foreach (GameObject panel in StorePanels)
        {
            panel.SetActive(false);
        }
    }


    public void GotoMain()
    {
        ChangeUI(UIManager.UIInstance.mainUI);
    }

    public void GotoWebStore()
    {
        Application.OpenURL("https://www.naver.com"); //web의 경로로 변경할것
    }


    /// <summary>
    /// 구매할 아이템 정보 , 개당 구매 가격, 구매 개수
    /// </summary>
    public static void ItemPurchase(int targetMasterId, int cost, int amount = 1)
    {
        //구매의 조건에 부합하는지 체크
        if (cost > DataManager.inven.GetData(1).quantity) //미네랄의 양 검사
        {
            //구매 불가 할경우. 알림 인터페이스 오픈
            UIManager.alertInterface.SetAlert("구매 불가/n미네랄이 부족합니다");
            return;
        }
        MasterData targetData = DataManager.master.GetData(targetMasterId);
        InvenData ownMineral = DataManager.inven.GetDataWithMasterId(1).Value;
        ownMineral.quantity = ownMineral.quantity - (cost * amount);

        DataManager.inven.UpdateData(ownMineral.id, ownMineral);

        //해당 아이템이 인벤토리에 존재하면 개수 증가  없으면 추가
        InvenData? checkData = DataManager.inven.GetDataWithMasterId(targetMasterId);
        if (checkData != null)
        {
            InvenData invenData = (InvenData)checkData;
            invenData.quantity += amount;
            DataManager.inven.UpdateData(invenData.id, invenData);
        }
        else
        {
            InvenData newData = new InvenData
            {
                id = DataManager.inven.GetLastKey()+1,
                masterId = targetMasterId,
                quantity = amount,
                name = targetData.name
            };

            DataManager.inven.AddData(newData);
        }

        DataManager.inven.SaveData();
        //완료시 파이어베이스로 보냄
        //DB_Firebase.UpdateFirebaseNodeFromJson(Auth_Firebase.Instance.UserId,nameof(InvenData),DataManager.inven.GetFilePath());

        //구매 성공시 알림 인터페이스 오픈
        UIManager.alertInterface.SetAlert("아이템을 구매하였습니다");
    }
}
 